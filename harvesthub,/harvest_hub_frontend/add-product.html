<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Product - HarvestHub</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2e7d32;
    }
    form {
      background: #fff;
      padding: 20px;
      max-width: 400px;
      margin: 30px auto;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    input, textarea, button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #2e7d32;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #1b5e20;
    }
    #message {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    #priceWarning {
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Add New Product</h1>
<form id="productForm" enctype="multipart/form-data">
  <input type="text" id="name" name="name" placeholder="Product Name" required>
  <input type="text" id="mandi" name="mandi" placeholder="Mandi/Market Name" required>
  <input type="text" id="category" name="category" placeholder="Category" required>
  <input type="number" id="price" name="price" placeholder="Price (₹)" required>
  <div id="priceWarning"></div>
  <input type="number" id="quantity" name="quantity" placeholder="Quantity" required>
  <input type="file" id="image" name="image" accept="image/*" required>
  <textarea id="description" name="description" placeholder="Description"></textarea>
  <button type="submit">Add Product</button>
</form>
<div id="message"></div>

<script>
  // Get logged-in farmer info from localStorage
  const userProfile = JSON.parse(localStorage.getItem("userProfile"));
if (!userProfile) {
  alert("⚠️ Please login first!");
  window.location.href = "login.html";
}

document.getElementById("productForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData();
  formData.append("name", document.getElementById("name").value.trim());
  formData.append("mandi", document.getElementById("mandi").value.trim()); // ✅ Make sure key matches backend
  formData.append("category", document.getElementById("category").value.trim());
  formData.append("price", document.getElementById("price").value.trim());
  formData.append("quantity", document.getElementById("quantity").value.trim());
  formData.append("description", document.getElementById("description").value.trim());
  formData.append("farmer_id", userProfile.id); 
  formData.append("image", document.getElementById("image").files[0]);

  try {
    const res = await fetch("http://localhost:5000/api/products", {
      method: "POST",
      body: formData
    });

    const result = await res.json();
    document.getElementById("message").textContent = res.ok ? "✅ Product Added!" : result.error;
    document.getElementById("message").style.color = res.ok ? "green" : "red";
  } catch (err) {
    console.error(err);
    document.getElementById("message").textContent = "Server error!";
    document.getElementById("message").style.color = "red";
  }
});

  // Live mandi price check (local cached data)
  const priceInput = document.getElementById("price");
  const nameInput = document.getElementById("name");
  const mandiInput = document.getElementById("mandi");
  const priceWarning = document.getElementById("priceWarning");

  let debounceTimer;
  priceInput.addEventListener("input", () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      const product = nameInput.value.trim().toLowerCase();
      const mandi = mandiInput.value.trim().toLowerCase();
      const enteredPrice = parseFloat(priceInput.value);

      if (!product || !mandi || isNaN(enteredPrice)) {
        priceWarning.textContent = "";
        return;
      }

      try {
        const res = await fetch(
          `http://localhost:5000/api/mandi-price?commodity=${encodeURIComponent(product)}&mandi=${encodeURIComponent(mandi)}`
        );
        const data = await res.json();

        if (res.ok && data.modal_price) {
          const mandiPricePerKg = data.modal_price / 100; // convert quintal to kg
          if (enteredPrice > mandiPricePerKg * 1.2) {
            priceWarning.textContent = `⚠️ Your price ₹${enteredPrice}/kg is much higher than mandi ₹${mandiPricePerKg.toFixed(2)}/kg`;
            priceWarning.style.color = "red";
          } else if (enteredPrice < mandiPricePerKg * 0.8) {
            priceWarning.textContent = `⚠️ Your price ₹${enteredPrice}/kg is much lower than mandi ₹${mandiPricePerKg.toFixed(2)}/kg`;
            priceWarning.style.color = "orange";
          } else {
            priceWarning.textContent = `✅ Fair price. Mandi modal: ₹${mandiPricePerKg.toFixed(2)}/kg`;
            priceWarning.style.color = "green";
          }
        } else {
          priceWarning.textContent = "⚠️ No mandi data found for this item";
          priceWarning.style.color = "gray";
        }

      } catch (err) {
        console.error("Error fetching mandi price:", err);
        priceWarning.textContent = "⚠️ Error fetching mandi data";
        priceWarning.style.color = "gray";
      }
    }, 500);
  });
</script>
</body>
</html>
